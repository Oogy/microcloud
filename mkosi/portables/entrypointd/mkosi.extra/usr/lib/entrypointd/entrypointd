#!/usr/bin/env python3

import datetime
import time
import http.client

if __name__ == '__main__':
    serial_path = '/sys/class/dmi/id/product_serial'
    with open(serial_path, 'r') as product_serial:
        serial = product_serial.read()

    while True:
        print(f"Hello @ {datetime.datetime.now()} from {serial}")

    while False:
        entrypointd_tag_path = '/usr/local/lib/entrypointd/entrypointd/tag'
        with open(entrypointd_tag_path, 'r') as entrypointd_tag_file:
            current_entrypointd_tag = entrypointd_tag_file.read()

        print(f"Hello from {serial} @ {datetime.datetime.now()}, entrypointd-{current_entrypointd_tag}")

        pages_host = "oogy.github.io"

        conn = http.client.HTTPSConnection(pages_host)

        conn.request("GET", '/microcloud/entrypointd.html', headers={"Host": pages_host})
        new_entrypointd_tag = conn.getresponse().read().decode('utf-8').strip()
        if old_entrypointd_tag != new_entrypointd_tag:
            # importctl pull-raw -P --verify=no <url>
            # mv /var/lib/portables/entrypointd_*.raw /var/lib/portables/entrypointd.raw.v
            # portablectl reattach --now entrypointd

        conn.request("GET", f"/microcloud/inventory/{serial}".strip(), headers={"Host": pages_host})
        import_images = conn.getresponse().read().decode('utf-8').strip().split('\n')

        for image in import_images:
            name, tag = image.split(',')

        time.sleep(60)
